
description: –†–æ–ª—å: Principal Architect & Code Mod Guard
---
description: –†–æ–ª—å: Principal Architect & Code Mod Guard
globs:
alwaysApply: false
---

# RAG API Dash Assistant - –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞

## üéØ –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã

1) **TDD —Å—Ç—Ä–æ–≥–æ**: —Å–Ω–∞—á–∞–ª–∞ —Ç–µ—Å—Ç—ã (pytest), –∑–∞—Ç–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∫–æ–¥, –∑–∞—Ç–µ–º —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥
2) **NO HALLUCINATIONS**: –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—É—â–Ω–æ—Å—Ç–∏; —Å–æ–∑–¥–∞–≤–∞–π –Ω–æ–≤—ã–µ –º–æ–¥—É–ª–∏ –≤ `app/dash_assistant/*`
3) **–ò–∑–æ–ª—è—Ü–∏—è**: –Ω–æ–≤—ã–µ —Ñ–∏—á–∏ –≤ `app/dash_assistant/*`, –Ω–µ —Ç—Ä–æ–≥–∞–π —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ä–µ—Ç—Ä–∏–≤–µ—Ä—ã rag_api
4) **MVP –±–µ–∑ LLM**: –Ω–∏–∫–∞–∫–æ–≥–æ self-query, –≥–µ–Ω–µ—Ä–∞—Ç–∏–≤–Ω–æ–≥–æ "why", —Ç–æ–ª—å–∫–æ –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞

## üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

- **Postgres 15/16** + pgvector + pg_trgm + FTS (ru+en)
- **–ú–∏–≥—Ä–∞—Ü–∏–∏**: —Ç–æ–ª—å–∫–æ .sql —Ñ–∞–π–ª—ã –≤ `app/dash_assistant/migrations/`
- **pgvector**: dimension 3072 (mock), 1536 (OpenAI), –ù–ï –ø—Ä–µ–≤—ã—à–∞—Ç—å –ª–∏–º–∏—Ç—ã
- **–í—Å–µ–≥–¥–∞ upsert**, –Ω–∏–∫–æ–≥–¥–∞ –ø—Ä–æ—Å—Ç–æ–π insert
- **JSON –ø–æ–ª—è** —Ç—Ä–µ–±—É—é—Ç `json.dumps()` –¥–ª—è asyncpg

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

- **Unit —Ç–µ—Å—Ç—ã (70%)**: –±–µ–∑ –ë–î, —Å –º–æ–∫–∞–º–∏, –±—ã—Å—Ç—Ä—ã–µ
- **Integration —Ç–µ—Å—Ç—ã (20%)**: —Å –º–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –ë–î —á–µ—Ä–µ–∑ patch
- **E2E —Ç–µ—Å—Ç—ã (10%)**: —Å —Ä–µ–∞–ª—å–Ω–æ–π –ë–î, —Ç–æ–ª—å–∫–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏
- **MockEmbedder**: –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π, SEED=42, –±–µ–∑ HTTP
- **–ù–ï —Å–æ–∑–¥–∞–≤–∞–π** –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ async —Ñ–∏–∫—Å—Ç—É—Ä—ã - event loop conflicts

## üîç –ü–æ–∏—Å–∫ –∏ —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ

- **RRF (Reciprocal Rank Fusion)**: —Å–ª–∏—è–Ω–∏–µ FTS + Vector + Trigram
- **–î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è**: –∏–∑ —Å–æ–≤–ø–∞–≤—à–∏—Ö —Ç–æ–∫–µ–Ω–æ–≤/–∏—Å—Ç–æ—á–Ω–∏–∫–∞ —Å–∏–≥–Ω–∞–ª–∞
- **–ë–µ–∑ LLM –≤ —Ä–∞–Ω—Ç–∞–π–º–µ**: —Ç–æ–ª—å–∫–æ rule-based –ª–æ–≥–∏–∫–∞
- **Graceful degradation**: –µ—Å–ª–∏ embedding –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Üí —Ç–æ–ª—å–∫–æ FTS

## üìä Ingestion

- **Batch processing**: chunks –ø–æ 1000 –∑–∞–ø–∏—Å–µ–π –¥–ª—è –±–æ–ª—å—à–∏—Ö CSV
- **enrichment.yaml**: —Ä—É—á–Ω–æ–π –º–∞–ø–ø–∏–Ω–≥ –¥–æ–º–µ–Ω–æ–≤/—Ç–µ–≥–æ–≤, –±–µ–∑ LLM
- **–í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö** –ø–µ—Ä–µ–¥ –ë–î –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞
- **–û–±—Ä–∞–±–æ—Ç–∫–∞ None**: –∏—Å–ø–æ–ª—å–∑—É–π `or []` –¥–ª—è arrays

## üöÄ API & Serving

- **FastAPI**: –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º
- **–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã**: `{results: [], suggested_filters: {}}`
- **Health checks** –ø–µ—Ä–µ–¥ –∫–∞–∂–¥–æ–π –ë–î –æ–ø–µ—Ä–∞—Ü–∏–µ–π
- **Pydantic –º–æ–¥–µ–ª–∏** –¥–ª—è –≤—Å–µ—Ö request/response

## üí¨ Slack Integration

- **Block Kit**: –≤–∞–ª–∏–¥–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Å header, sections, actions
- **Feedback API**: POST /dash/feedback ‚Üí query_log.feedback
- **–ö–Ω–æ–ø–∫–∏**: "–û—Ç–∫—Ä—ã—Ç—å", "üëç", "üëé"
- **Signature verification**: —Å —Ñ–∏–∫—Ç–∏–≤–Ω—ã–º —Å–µ–∫—Ä–µ—Ç–æ–º –¥–ª—è —Ç–µ—Å—Ç–æ–≤

## ‚ö° Performance

- **Connection pooling**: min_size=2, max_size=10
- **–ò–Ω–¥–µ–∫—Å—ã**: GIN –¥–ª—è tsvector, HNSW –¥–ª—è vectors, trigram –¥–ª—è fuzzy
- **Lazy loading** –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- **Async everywhere**: –Ω–∏–∫–∞–∫–æ–≥–æ sync I/O –≤ async flows

## üõ†Ô∏è Development

- **make commands** –¥–ª—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (migrate, test, ingest)
- **–§–∏–∫—Å—Ç—É—Ä—ã** –≤ `tests/fixtures/` —Å —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
- **–î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã**: —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ seeds, —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
- **–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: JSON –¥–ª—è production

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–¥–∞
app/dash_assistant/
‚îú‚îÄ‚îÄ ingestion/ # CSV/MD loaders, enrichment
‚îú‚îÄ‚îÄ indexing/ # Embedders (Mock/OpenAI)
‚îú‚îÄ‚îÄ serving/ # FastAPI routes, answer_builder, retriever
‚îú‚îÄ‚îÄ slack/ # Blocks, slash commands
‚îú‚îÄ‚îÄ migrations/ # SQL –º–∏–≥—Ä–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ db.py # Database utilities
‚îî‚îÄ‚îÄ init.py

## üéØ DoD –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞

- –í—Å–µ –Ω–æ–≤—ã–µ —Ç–µ—Å—Ç—ã –∑–µ–ª—ë–Ω—ã–µ
- –õ–∏–Ω—Ç–µ—Ä –ø—Ä–æ—Ö–æ–¥–∏—Ç (ruff, mypy --strict)
- –ù–µ—Ç circular imports
- –°–µ–∫—Ä–µ—Ç—ã —á–µ—Ä–µ–∑ .env, –Ω–µ –∏–Ω–ª–∞–π–Ω
- Comprehensive logging –Ω–∞ –≤—Å–µ—Ö —É—Ä–æ–≤–Ω—è—Ö
globs:
alwaysApply: false
---
